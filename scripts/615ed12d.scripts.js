"use strict";angular.module("interfaceApp",["ngCookies","ngSanitize","ngRoute","ngAnimate"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/site/:code/:explore",{templateUrl:"views/site.html",controller:"SiteCtrl"}).when("/play/:code/:explore",{templateUrl:"views/play.html",controler:"PlayCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("interfaceApp").controller("MainCtrl",["$scope","configuration","$http",function(a,b,c){var d=b[b.service]+"?callback=JSON_CALLBACK";console.log(d),c.jsonp(d).then(function(b){var c=[];angular.forEach(b.data.sites,function(a,b){c.push([b,a])}),a.sites=c.sort()})}]),angular.module("interfaceApp").constant("configuration",{development:"http://dev01:3000/app",testing:"",production:"",service:"development",solr:"https://data.esrc.info/solr/ESRC/select",highlight:{contextNode:"green",contextNeighbourDefault:"orange",contextNeighbourHighlight:"blue","default":"grey"},opacity:{highlight:"1",fade:"0.3"}}),angular.module("interfaceApp").controller("SiteCtrl",["$rootScope","$scope","$routeParams","$http","$timeout","configuration","DataService",function(a,b,c,d,e,f,g){b.site=c.code,b.graph=c.explore,b.service=f[f.service],a.$on("graph-ready",function(){b.showControls=!0});var h=function(){b.progress=!1,b.datasetError=!1,b.controls=!1,b.total=0,b.processed=0;var a=b.service+"/network/"+b.site+"/"+b.graph+"?callback=JSON_CALLBACK";console.log(a),d.jsonp(a).then(function(){e(function(){b.update()},200),b.progress=!1},function(){b.datasetError=!0,b.progress=!1})};h(),b.update=function(){var a=b.service+"/network/"+b.site+"/"+b.graph+"/status?callback=JSON_CALLBACK";d.jsonp(a).then(function(a){null!==a.data.processed?(b.progress=!0,b.controls=!1,b.processed=a.data.processed,b.total=a.data.total,e(function(){b.update()},100)):(b.progress=!1,b.controls=!0,b.processData(a.data))},function(){b.progress=!1})},b.processData=function(c){console.log("update graph");var d,e=JSON.parse(c.graph).nodes,f=JSON.parse(c.graph).links,h=[],i=[],j=0,k=[],l={},m=[],n=[];for(d=0;d<e.length;d++){var o=e[d].id,p=e[d].type,q=e[d].url,r=e[d].connections;l[o]={type:p,connections:r,url:q},n.push(r)}for(n=[Math.min.apply(null,n),Math.max.apply(null,n)],d=0;d<f.length;d++){j++;var s=f[d].source_name,t=f[d].target_name;-1===k.indexOf(s)&&(k.push(s),l[s].name=s,h.push(l[s])),-1===k.indexOf(t)&&(k.push(t),l[t].name=t,h.push(l[t])),i.push({source:k.indexOf(s),target:k.indexOf(t)})}var m=[];for(d=0;d<e.length;d++){var o=e[d].id;-1===k.indexOf(o)&&m.push({name:o})}g.nodes=h,g.links=i,g.unConnectedNodes=m,g.weightBounds=n,a.$broadcast("graph-data-loaded"),b.ready=!0}}]),angular.module("interfaceApp").directive("forceNetworkGraph",["$rootScope","$window","$http","$routeParams","configuration","DataService",function(a,b,c,d,e,f){return{templateUrl:"views/force-network-graph.html",restrict:"E",scope:{},link:function(d){a.$on("force-reset",function(){n.attr("class","link").attr("stroke","#ccc").attr("stroke-width",2).attr("opacity","1"),o.attr("class","node").attr("r",function(a){return d.weight(a.connections)}).attr("fill",function(a){return d.color(a.type)}).attr("opacity","1")}),d.nodes=f.nodes,d.links=f.links,console.log(d.nodes);var g=f.weightBounds;d.data={},angular.forEach(d.nodes,function(a){d.data[a.name]=a});var h=b.innerWidth,i=b.innerHeight;d3.select("svg").remove(),d.color=d3.scale.category20(),d.weight=d3.scale.linear().range([10,80]),d.weight.domain([Math.min.apply(null,g),Math.max.apply(null,g)]),d.unConnectedNodes=[];var j=function(){m.attr("transform","translate("+d3.event.translate+") scale("+d3.event.scale+")")};d.tickCounter=0;var k=function(){n.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}),o.attr("transform",function(a){return"translate("+a.x+","+a.y+")"}),d.tickCounter+=1,2===d.tickCounter&&(d.tickCounter=0,d.$apply(function(){d.total=.1,d.processed=l.alpha()})),l.alpha()<.0055&&d.$apply(function(){d.relaxed=!0})},l=d3.layout.force().nodes(d.nodes).links(d.links).charge(-1e3).linkDistance(100).linkStrength(1).size([h,i]).on("tick",k).start(),m=d3.select("#graph").append("svg").attr("width",h).attr("height",i).attr("viewBox","0 0 "+h+" "+i).attr("preserveAspectRatio","xMidYMid meet").call(d3.behavior.zoom().scaleExtent([0,8]).on("zoom",j)).append("g"),n=m.selectAll(".link").data(l.links()),o=m.selectAll(".node").data(l.nodes());n.enter().append("line").attr("class","link").attr("stroke","#ccc").attr("stroke-width",2),n.exit().remove(),o.enter().append("circle").attr("class","node").attr("r",function(a){return d.weight(a.connections)}).attr("fill",function(a){return d.color(a.type)}),o.exit().remove(),o.on("click",function(b){var g=b.name,h=[];h.push(g),angular.forEach(l.links(),function(a){var b=a.source.name,c=a.target.name;(b===g||c===g)&&(-1===h.indexOf(b)&&h.push(b),-1===h.indexOf(c)&&h.push(c))}),o.transition().attr("fill",function(a){return a.name===g?e.highlight.contextNode:-1!==h.indexOf(a.name)?e.highlight.contextNeighbourDefault:e.highlight.default}).attr("opacity",function(a){return-1!==h.indexOf(a.name)||a.name===g?e.opacity.highlight:e.opacity.fade}),n.transition().attr("stroke",function(a){return a.source.name===g&&-1!==h.indexOf(a.target.name)?e.highlight.contextNeighbourDefault:-1!==h.indexOf(a.source.name)&&a.target.name===g?e.highlight.contextNeighbourDefault:e.highlight.default}).attr("opacity",function(a){return a.source.name===g&&-1!==h.indexOf(a.target.name)?"1":-1!==h.indexOf(a.source.name)&&a.target.name===g?"1":"0.1"});h.shift();if(void 0!==d.data[g].url){var i=e.solr+'?spellcheck=off&q=id:"'+d.data[g].url+'"&wt=json&json.wrf=JSON_CALLBACK';c.jsonp(i).then(function(b){b.data.response.docs[0].nodeid=g,f.contextNodeData=b.data.response.docs[0],a.$broadcast("context-node-data-ready")},function(){})}else f.contextNodeData=b,a.$broadcast("context-node-data-ready");f.contextNetworkData=[],angular.forEach(h,function(b){if(void 0!==d.data[b].url){var g=e.solr+'?spellcheck=off&q=id:"'+d.data[b].url+'"&wt=json&json.wrf=JSON_CALLBACK';c.jsonp(g).then(function(c){c.data.response.docs[0].nodeid=b,f.contextNetworkData.push(c.data.response.docs[0]),a.$broadcast("context-node-neighbour-data-ready")},function(){})}else a.$broadcast("context-node-neighbour-data-ready")})}),l.start(),l.on("end",function(){a.$broadcast("graph-ready")})}}}]),angular.module("interfaceApp").directive("progressMeter",function(){return{templateUrl:"views/progress-meter.html",restrict:"E",scope:{processed:"@",total:"@",invert:"@"},link:function(a){a.$watch("processed",function(){b()});var b=function(){var b=a.processed/a.total*100;a.width=angular.fromJson(a.invert)===!0?100-b||1:b}}}}),angular.module("interfaceApp").controller("PlayCtrl",["$scope","$window",function(a,b){function c(){m.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}),l.attr("transform",function(a){return"translate("+a.x+","+a.y+")"})}function d(){k.attr("transform","translate("+d3.event.translate+") scale("+d3.event.scale+")")}a.items=["E1","E2","E3","E4","E5","E6","E7","E8","E9","E10"];var e=b.innerWidth,f=b.innerHeight;d3.select("svg").remove();var g=d3.scale.category20(),h=[{name:"E0"}],i=[],j=d3.layout.force().nodes(h).links(i).charge(-1e3).linkDistance(100).linkStrength(1).size([e,f]).on("tick",c),k=d3.select("#graph").append("svg").attr("width",e).attr("height",f).attr("viewBox","0 0 "+e+" "+f).attr("preserveAspectRatio","xMidYMid meet").call(d3.behavior.zoom().scaleExtent([0,8]).on("zoom",d)).append("g");k.append("g").attr("class","links"),k.append("g").attr("class","nodes");var l=k.select(".nodes").selectAll(".node"),m=k.select(".links").selectAll(".link");a.removeOne=function(){var b=h.splice(0,1);i.splice(0,1),a.items.push(b[0].name),n()},a.addOne=function(){var b=a.items.shift(),c={source:h.length-1,target:h.length};h.push({name:b}),i.push(c),n()},a.addTen=function(){for(var b=0;5>b;b++)a.addOne()};var n=function(){j.start(),console.log(i),m=m.data(i),m.enter().append("line").attr("class","link").attr("stroke","#ccc").attr("stroke-width",2),m.exit().remove(),console.log(h),l=l.data(h),l.enter().append("circle").attr("class","node").attr("r",10).attr("fill",function(){return g(Math.random())}),l.exit().remove()}}]),angular.module("interfaceApp").directive("controls",["$http","$window","$rootScope","DataService","configuration",function(a,b,c,d,e){return{templateUrl:"views/controls.html",restrict:"E",scope:{site:"@",entity:"@",graph:"@"},link:function(f){f.cls={top:10,left:b.innerWidth-570,width:550,height:b.innerHeight-100},f.highlightedTypes=[],f.color=d3.scale.category20(),c.$on("graph-data-loaded",function(){f.data={nodes:d.nodes,links:d.links,percentUnConnected:d.unConnectedNodes.length/(d.nodes.length+d.unConnectedNodes.length)*100},g(),h()});var g=function(){f.service=e[e.service];var b=f.service+"/stats/"+f.site+"/"+f.graph+"?callback=JSON_CALLBACK";a.jsonp(b).then(function(a){f.data.name=a.data.name,f.data.url=a.data.url},function(){console.log("Service failure when asking for network degree")})},h=function(){var a={};angular.forEach(f.data.nodes,function(b){void 0===a[b.type]?a[b.type]=1:a[b.type]+=1}),f.data.types=a};c.$on("context-node-data-ready",function(){f.contextNodeData=d.contextNodeData}),c.$on("context-node-neighbour-data-ready",function(){var a={};angular.forEach(d.contextNetworkData,function(b){var c=b.type;void 0===a[c]&&(a[c]=[]),b.checked=!1,a[c].push(b)}),f.contextNetworkData=a}),f.highlight=function(a){angular.forEach(f.contextNetworkData,function(b){b.nodeid===a&&(b.checked=!b.checked)}),d3.selectAll(".node").attr("fill",function(b){return b.name===a?"blue"===d3.select(this).attr("fill")?e.highlight.contextNeighbourDefault:e.highlight.contextNeighbourHighlight:d3.select(this).attr("fill")})},f.selectAll=function(a){angular.forEach(f.contextNetworkData,function(b,c){c===a&&angular.forEach(b,function(a){a.checked=!a.checked,f.highlight(a.nodeid)})})},f.highlightByType=function(a){-1===f.highlightedTypes.indexOf(a)?f.highlightedTypes.push(a):f.highlightedTypes.splice(f.highlightedTypes.indexOf(a),1),d3.selectAll(".node").attr("fill",function(a){return-1!==f.highlightedTypes.indexOf(a.type)?f.color(a.type):e.highlight.default}).attr("opacity",function(a){return-1!==f.highlightedTypes.indexOf(a.type)?e.opacity.highlight:e.opacity.fade}).attr("r","10").transition(4).attr("r",function(a){return-1!==f.highlightedTypes.indexOf(a.type)?"30":"10"}),d3.selectAll(".link").attr("opacity",function(a){return-1!==f.highlightedTypes.indexOf(a.type)?e.opacity.highlight:e.opacity.fade})},f.sizeNodesEvenly=function(){d3.selectAll(".node").attr("r","10")},f.reset=function(){c.$broadcast("force-reset"),f.contextNodeData=void 0,f.contextNetworkData=void 0,f.highlightedTypes=[]}}}}]),angular.module("interfaceApp").service("DataService",[function(){var a={nodes:[],unConnectedNodes:[],links:[]};return a}]);