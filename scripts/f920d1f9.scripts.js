"use strict";angular.module("interfaceApp",["ngCookies","ngSanitize","ngRoute","ngAnimate"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/site/:code/:explore",{templateUrl:"views/site.html",controller:"SiteCtrl"}).when("/play",{templateUrl:"views/play.html",controler:"PlayCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("interfaceApp").controller("MainCtrl",["$scope","configuration","$http",function(a,b,c){var d=b[b.service]+"?callback=JSON_CALLBACK";console.log(d),c.jsonp(d).then(function(b){var c=[];angular.forEach(b.data.sites,function(a,b){c.push([b,a])}),a.sites=c.sort(),a.serviceUnavailable=!1},function(){a.serviceUnavailable=!0})}]),angular.module("interfaceApp").constant("configuration",{development:"http://dev01:3000/app",testing:"https://cnex.esrc.info/app",production:"",service:"testing",solr:"https://data.esrc.info/solr/ESRC/select",fill:{contextNode:"green",contextNeighbourDefault:"orange",contextNeighbourHighlight:"red","default":"#C8C8C8"},opacity:{"default":"1",unselected:"0.7"},stroke:{link:{selected:"orange",unselected:"#C8C8C8"},date:{selected:"black",unselected:"#C8C8C8"}},height:{selected:"10","default":"3"},radius:{node:{selected:"30",unselected:"10"},date:{selected:"6","default":"3"}}}),angular.module("interfaceApp").controller("SiteCtrl",["$rootScope","$scope","$routeParams","$http","$timeout","configuration","DataService",function(a,b,c,d,e,f,g){b.site=c.code,b.graph=c.explore,b.service=f[f.service],a.$on("graph-ready",function(){b.showControls=!0}),b.progress=!1,b.datasetError=!1,b.controls=!1,b.total=0,b.processed=0;var h=b.service+"/network/"+b.site+"/"+b.graph+"?callback=JSON_CALLBACK";console.log(h),d.jsonp(h).then(function(a){e(function(){b.update()},200),b.progress=!1,g.site={name:a.data.name,url:a.data.url}},function(){b.datasetError=!0,b.progress=!1}),b.update=function(){var a=b.service+"/network/"+b.site+"/"+b.graph+"/status?callback=JSON_CALLBACK";d.jsonp(a).then(function(a){null!==a.data.processed?(b.progress=!0,b.controls=!1,b.processed=a.data.processed,b.total=a.data.total,e(function(){b.update()},100)):(b.progress=!1,b.controls=!0,b.processData(a.data))},function(){b.progress=!1})},b.processData=function(c){var d,e=JSON.parse(c.graph).nodes,f=JSON.parse(c.graph).links,h=[],i={},j=[],k=0,l=[],m={},n=[],o=[];for(d=0;d<e.length;d++){var p=e[d].id,q=e[d].connections;m[p]=e[d],o.push(q)}for(o=[Math.min.apply(null,o),Math.max.apply(null,o)],d=0;d<f.length;d++){k++;var r=f[d].source_name,s=f[d].target_name;-1===l.indexOf(r)&&(l.push(r),h.push(m[r]),i[r]=m[r]),-1===l.indexOf(s)&&(l.push(s),h.push(m[s]),i[s]=m[s]),j.push({source:l.indexOf(r),target:l.indexOf(s)})}var n=[];for(d=0;d<e.length;d++){var p=e[d].id;-1===l.indexOf(p)&&n.push(e[d])}var t=d3.scale.category20();for(d=0;d<h.length;d++)h[d].color=t(h[d].type);g.nodes=h,g.nodeMap=i,g.links=j,g.unConnectedNodes=n,g.weightBounds=o,a.$broadcast("graph-data-loaded"),b.ready=!0}}]),angular.module("interfaceApp").directive("forceNetworkGraph",["$rootScope","$window","$http","$routeParams","configuration","DataService","D3Service",function(a,b,c,d,e,f,g){return{templateUrl:"views/force-network-graph.html",restrict:"E",scope:{},link:function(c){a.$on("reset",function(){n.transition().attr("class","link").attr("stroke","#ccc").attr("stroke-width",2).attr("opacity",e.opacity.default),o.transition().attr("class","node").attr("r",function(a){return c.weight(a.connections)}).attr("fill",function(a){return a.color}).attr("opacity",e.opacity.default)}),c.nodes=f.nodes,c.links=f.links,console.log(c.nodes);var d=f.weightBounds;c.data={},angular.forEach(c.nodes,function(a){c.data[a.id]=a});var h=b.innerWidth,i=b.innerHeight;c.weight=d3.scale.linear().range([10,80]),c.weight.domain([Math.min.apply(null,d),Math.max.apply(null,d)]),c.unConnectedNodes=[];var j=function(){m.attr("transform","translate("+d3.event.translate+") scale("+d3.event.scale+")")};c.tickCounter=0;var k=function(){n.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}),o.attr("transform",function(a){return"translate("+a.x+","+a.y+")"}),c.tickCounter+=1,2===c.tickCounter&&(c.tickCounter=0,c.$apply(function(){c.total=.1,c.processed=l.alpha()})),l.alpha()<.0055&&c.$apply(function(){c.relaxed=!0})},l=d3.layout.force().nodes(c.nodes).links(c.links).charge(-1e3).linkDistance(100).linkStrength(1).size([h,i]).on("tick",k).start(),m=d3.select("#graph").append("svg").attr("width",h).attr("height",i).attr("viewBox","0 0 "+h+" "+i).attr("preserveAspectRatio","xMidYMid meet").call(d3.behavior.zoom().scaleExtent([0,8]).on("zoom",j)).append("g"),n=m.selectAll(".link").data(l.links()),o=m.selectAll(".node").data(l.nodes());n.enter().append("line").attr("class","link").attr("stroke","#ccc").attr("stroke-width",2),n.exit().remove(),o.enter().append("circle").attr("class","node").attr("r",function(a){return c.weight(a.connections)}).attr("fill",function(a){return a.color}).attr("id",function(a){return g.sanitize(a.id)+"_node"}),o.exit().remove(),o.on("click",function(a){a.id;c.$apply(function(){g.highlightNodeAndLocalEnvironment(a.id)})}),l.start()}}}]),angular.module("interfaceApp").directive("progressMeter",function(){return{templateUrl:"views/progress-meter.html",restrict:"E",scope:{processed:"@",total:"@",invert:"@"},link:function(a){a.$watch("processed",function(){b()});var b=function(){var b=a.processed/a.total*100;a.width=angular.fromJson(a.invert)===!0?100-b||1:b}}}}),angular.module("interfaceApp").controller("PlayCtrl",["$scope","$window",function(a){var b=500,c=400,d=[{name:"AE1",df:2010,dt:null},{name:"AE2",df:2005,dt:2011},{name:"AE3",df:null,dt:2011}];a.points=[],a.ranges=[],angular.forEach(d,function(b){null!==b.df&&null!==b.dt?a.ranges.push(b):(null!==b.df||null!==b.dt)&&a.points.push(b)}),console.log(a.ranges),console.log(a.points),d3.select("svg").remove();var e=(d3.scale.category20(),new Date(2e3,0,1)),f=new Date(2014,12,31),g=d3.time.scale().domain([e,f]).range([30,b-30]),h=d3.svg.axis().scale(g).ticks(d3.time.years).tickSize(6,0).orient("bottom"),i=d3.scale.linear().domain([0,1]).range([30,c-100]),j=d3.select("#graph").append("svg").attr("width",b).attr("height",c),k=(j.append("g").attr("class","axis").attr("transform","translate(0,"+(c-100)+")").call(h),j.selectAll("rect").data(a.ranges));k.enter().append("rect").attr("class","rect").attr("x",function(a){var b=Date.parse(a.df);return console.log(a.name,"x",g(b)),g(b)}).attr("y",function(a){return console.log(a.name,"y",i(Math.random())),i(Math.random())}).attr("width",function(a){if(void 0===a.dt||""===a.dt)return 100;var b=Date.parse(a.df),c=Date.parse(a.dt);return g(c)-g(b)}).attr("height","10").attr("fill","grey");var l=j.selectAll("circle").data(a.points);l.enter().append("circle").attr("class","circle").attr("cx",function(a){if(null!==a.df)var b=Date.parse(a.df);else var b=Date.parse(a.dt);return console.log(a.name,"x",g(b)),g(b)}).attr("cy",function(a){return console.log(a.name,"y",i(Math.random())),i(Math.random())}).attr("r","5").attr("fill",function(a){return null!==a.df?"red":"green"})}]),angular.module("interfaceApp").directive("controls",["$http","$window","$rootScope","DataService","configuration","D3Service",function(a,b,c,d,e,f){return{templateUrl:"views/controls.html",restrict:"E",scope:{site:"@",entity:"@",graph:"@"},link:function(a){a.cls={top:10,left:b.innerWidth-570,width:550,height:b.innerHeight-100},a.showData=!1,c.$on("reset",function(){angular.forEach(a.data.types,function(b,c){a.data.types[c].checked=!1}),a.contextNodeData=void 0,a.contextNetworkData=void 0,a.showData=!1}),c.$on("graph-data-loaded",function(){a.siteData=d.site,a.data={nodes:d.nodes,links:d.links,percentUnConnected:d.unConnectedNodes.length/(d.nodes.length+d.unConnectedNodes.length)*100};var b={};angular.forEach(a.data.nodes,function(a){void 0===b[a.type]?b[a.type]={count:1,checked:!1,color:a.color}:b[a.type].count+=1}),a.data.types=b}),c.$on("search-result-data-ready",function(){var b={};void 0===d.contextNode&&(a.contextNodeData=void 0),angular.forEach(d.selected,function(c){if(c===d.contextNode)a.contextNodeData=d.nodeMap[c];else{var e=d.nodeMap[c];void 0===b[e.type]&&(b[e.type]=[]),e.checked=!1,b[e.type].push(e)}}),a.contextNetworkData=b}),a.highlight=function(b){angular.forEach(a.contextNetworkData,function(a){a.id===b&&(a.checked=!a.checked)}),f.highlightNode(b)},a.selectAll=function(b){angular.forEach(a.contextNetworkData,function(a,c){c===b&&angular.forEach(a,function(a){a.checked=!a.checked,f.highlightNode(a.id)})})},a.highlightByType=function(b){a.data.types[b].checked=!a.data.types[b].checked,f.highlightByType(b)},a.sizeNodesEvenly=function(){f.sizeNodesEvenly()},a.reset=function(){f.reset()}}}}]),angular.module("interfaceApp").service("DataService",["$http","$rootScope","configuration",function(a,b){function c(a,c){d.selected=a,d.contextNode=c,b.$broadcast("search-result-data-ready")}var d={nodes:[],unConnectedNodes:[],links:[],getNodeData:c};return d}]),angular.module("interfaceApp").directive("dateVis",["$rootScope","configuration","DataService","D3Service",function(a,b,c,d){return{templateUrl:"views/date-vis.html",restrict:"E",scope:{width:"@",height:"@"},link:function(e){a.$on("reset",function(){var a=d3.selectAll(".rect");a.attr("fill",b.fill.default).attr("opacity",b.opacity.default).attr("height",b.height.default).attr("stroke",b.stroke.date.default);var c=d3.selectAll(".circle");c.attr("fill",b.fill.default).attr("opacity",b.opacity.default).attr("r",b.radius.date.default).attr("stroke",b.stroke.date.default)}),a.$on("graph-data-loaded",function(){d3.select("#datevis").select("svg").remove();var a=c.nodes,f=[],g=[],h=[];angular.forEach(a,function(a){null!==a.df&&null!==a.dt?(h.push(a.df),h.push(a.dt),g.push(a)):null!==a.df?(h.push(a.df),f.push(a)):null!==a.dt&&(h.push(a.dt),f.push(a))});var i=Date.parse(d3.min(h)),j=Date.parse(d3.max(h)),k=d3.time.scale().domain([i,j]).range([10,e.width-20]),l=d3.svg.axis().scale(k).ticks(d3.time.years).ticks(6).orient("bottom"),m=d3.select("#datevis").append("svg").attr("width",e.width).attr("height",e.height).append("g"),n=(m.append("g").attr("class","axis").attr("transform","translate(0,"+(e.height-30)+")").call(l),d3.scale.linear().domain([0,g.length]).range([10,e.height-40])),o=m.selectAll(".rect").data(g);o.enter().append("rect").attr("class","rect").attr("x",function(a){var b=Date.parse(a.df);return k(b)}).attr("y",function(a,b){return n(b)}).attr("width",function(a){var b=Date.parse(a.df),c=Date.parse(a.dt);return k(c)-k(b)}).attr("height",b.height.default).attr("fill",b.fill.default).attr("id",function(a){return d.sanitize(a.id)+"_date"}).on("click",function(a){d.highlightNodeAndLocalEnvironment(a.id)}),n.domain([0,f.length]);var p=m.selectAll("circle").data(f);p.enter().append("circle").attr("class","circle").attr("cx",function(a){if(null!==a.df)var b=Date.parse(a.df);else var b=Date.parse(a.dt);return k(b)}).attr("cy",function(a,b){return n(b)}).attr("r",b.radius.date.default).attr("fill",b.fill.default).attr("id",function(a){return d.sanitize(a.id)+"_date"}).on("click",function(a){d.highlightNodeAndLocalEnvironment(a.id)})})}}}]),angular.module("interfaceApp").service("D3Service",["$rootScope","configuration","DataService",function(a,b,c){function d(a){var d=c.nodes,e=c.links,f=[],g={},h={},i={},j={},k={},l={},m={},o={};angular.forEach(e,function(c){var d=c.source.id,e=c.target.id;(d===a||e===a)&&(-1===f.indexOf(d)&&f.push(d),-1===f.indexOf(e)&&f.push(e)),c.source.id===a&&-1!==f.indexOf(c.target.id)?(m[c.source.id+"-"+c.target.id]=b.stroke.link.selected,o[c.source.id+"-"+c.target.id]=b.opacity.default):c.target.id===a&&-1!==f.indexOf(c.source.id)?(m[c.source.id+"-"+c.target.id]=b.stroke.link.selected,o[c.source.id+"-"+c.target.id]=b.opacity.default):(m[c.source.id+"-"+c.target.id]=b.stroke.link.unselected,o[c.source.id+"-"+c.target.id]=b.opacity.unselected)}),angular.forEach(d,function(c){c.id===a?(g[c.id]=b.fill.contextNode,h[c.id]=b.opacity.default,i[c.id]=b.stroke.date.selected,j[c.id]=b.height.selected,k[c.id]=b.radius.node.selected,l[c.id]=b.radius.date.selected):-1!==f.indexOf(c.id)?(g[c.id]=b.fill.contextNeighbourDefault,h[c.id]=b.opacity.default,i[c.id]=b.stroke.date.selected,j[c.id]=b.height.selected,k[c.id]=b.radius.node.selected,l[c.id]=b.radius.date.selected):(g[c.id]=b.fill.default,h[c.id]=b.opacity.unselected,i[c.id]=b.stroke.date.unselected,j[c.id]=b.height.default,k[c.id]=b.radius.node.unselected,l[c.id]=b.radius.date.default)}),n.highlightNodes("id",g,h,k),n.highlightLinksById(m,o),n.highlightRects("id",g,h,j,i),n.highlightPoints("id",g,h,i,l),c.getNodeData(f,a)}function e(a,b,c,d){var e=d3.selectAll(".node");void 0===d?e.transition().attr("fill",function(c){return b[c[a]]}).attr("opacity",function(b){return c[b[a]]}):e.transition().attr("fill",function(c){return b[c[a]]}).attr("opacity",function(b){return c[b[a]]}).attr("r",function(b){return d[b[a]]})}function f(a){var d,e;void 0!==c.contextNode?(d=b.fill.contextNeighbourDefault,e=b.fill.contextNeighbourDefault):(d=c.nodeMap[a].color,e=c.nodeMap[a].color);var f=d3.select("#"+n.sanitize(a)+"_node");f.attr("fill")===b.fill.contextNeighbourHighlight?f.attr("fill",d):f.attr("fill",b.fill.contextNeighbourHighlight);var g=d3.select("#"+n.sanitize(a)+"_date");try{g.attr("fill")===b.fill.contextNeighbourHighlight?g.attr("fill",e):g.attr("fill",b.fill.contextNeighbourHighlight)}catch(h){}}function g(a,b){var c=d3.selectAll(".link");c.attr("stroke",function(b){return a[b.source.id+"-"+b.target.id]}).attr("opacity",function(a){return b[a.source.id+"-"+a.target.id]})}function h(a,b,c,d,e){var f=d3.selectAll(".rect");f.attr("fill",function(c){return b[c[a]]}).attr("opacity",function(b){return c[b[a]]}).attr("height",function(b){return d[b[a]]}).attr("stroke",function(b){return e[b[a]]})}function i(a,b,c,d,e){var f=d3.selectAll(".circle");f.attr("fill",function(c){return b[c[a]]}).attr("opacity",function(b){return c[b[a]]}).attr("r",function(b){return e[b[a]]}).attr("stroke",function(b){return d[b[a]]})}function j(a){var d=n.highlightedTypes,e=c.nodes,f=c.links,g=d.indexOf(a);if(-1===g?d.push(a):d.splice(g,1),0===d.length)return n.highlightedTypes=d,void n.reset();var h=[],i=[],j=[],k=[],l=[],m=[],o=[],p=[],q=[];angular.forEach(e,function(a){-1!==d.indexOf(a.type)?(h[a.type]=a.color,i[a.type]=b.opacity.default,j[a.type]=b.radius.node.selected,k[a.type]=b.radius.date.selected,l[a.type]=b.height.selected,m[a.type]=b.stroke.date.selected,q.push(a.id)):(h[a.type]=b.fill.default,i[a.type]=b.opacity.unselected,j[a.type]=b.radius.node.unselected,k[a.type]=b.radius.node.default,l[a.type]=b.height.default,m[a.type]=b.stroke.date.unselected)}),angular.forEach(f,function(a){o[a.source.id+"-"+a.target.id]=b.stroke.unselected,p[a.source.id+"-"+a.target.id]=b.opacity.unselected}),n.highlightNodes("type",h,i,j),n.highlightLinksById(o,p),n.highlightRects("type",h,i,l,m),n.highlightPoints("type",h,i,m,k),n.highlightedTypes=d,c.getNodeData(q,void 0)}function k(){d3.selectAll(".node").transition().attr("r",b.radius.node.unselected)}function l(){n.highlightedTypes=[],a.$broadcast("reset")}function m(a){var b=a.replace(/\(|\)/g,"").replace(/ /g,"_");return b}var n={highlightedTypes:[],colors:d3.scale.category20(),highlightNodeAndLocalEnvironment:d,highlightNodes:e,highlightNode:f,highlightLinksById:g,highlightRects:h,highlightPoints:i,highlightByType:j,sizeNodesEvenly:k,reset:l,sanitize:m};return n}]);